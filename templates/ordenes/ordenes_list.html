{% extends 'home/base.html' %}
{% load static %}

{% block title %}
Dashboard
{% endblock title %}

{% load bootstrap5 %}
<!--<body id="page-top"> -->

<!-- Begin Page Content -->
{% block content %}
  {{ block.super }}
  <div class="container">
    <div class="text-center" style="padding-bottom: 20px;">
        <a type="button" href="{% url 'ordenes:orden_form' %}" class="btn btn-success"><span class="fa fa-plus-circle"></span> Crear Orden</a>
    </div>
  <div class="row table-responsive" style="display: flex; justify-content: center; align-items: center;">
    <table id="tabla-ordenes" class="table table-striped table-responsive" style="width:100%">
        <thead>
            <tr>
                <th id="sorting sorting_asc">pk</th>
                <th>Nombres y Apellidos</th>
                <th>Cédula</th>
                <th>Marca</th>
                <th>Vehículo</th>
                <th>Placa</th>
                <th>Estado</th>
                <th>Fecha Ingreso</th>
                <th>Acciones</th>
            </tr>
        </thead>
        <tbody>
            {% for orden in ordenes %}
            <tr>
                <td>{{orden.pk}}</td>
                <td>{{orden.cliente}}</td>
                <td>{{orden.cliente.cedula}}</td>
                <td>{{orden.vehiculo.marca}}</td>
                <td>{{orden.vehiculo}}</td>
                <td>{{orden.vehiculo.placa}}</td>
                <td>{{orden.estado}}</td>
                <td>{{orden.fecha_ingreso}}</td>
                <td>
                    <a href="{% url 'ordenes:orden_edit' orden.pk %}" class="btn btn-warning"  title="Editar"><span class="fa fa-edit"></span></a>
                    <!-- <a href="" class="btn btn-primary"  title="Ver"><span class="fa fa-eye"></span></a> -->
                    <a href="{% url 'ordenes:historial' orden.pk %}"  class="btn btn-success" title="Historial"><span class="fa fa-boxes "></span></a>
                    <!-- <a href="" class="btn btn-danger"  title="Eliminar"><span class="fa fa-trash"></span></a> -->
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
</div>
  {% if abrir_whatsapp_url %}
  <script>
    (function() {
      var url = "{{ abrir_whatsapp_url|escapejs }}";
      if (!url) return;
      // Intentar abrir WhatsApp automáticamente en una nueva pestaña
      var win = window.open(url, '_blank', 'noopener,noreferrer');
      // Si el navegador bloquea el popup, mostrar un botón para que el usuario lo abra manualmente
      if (!win) {
        // Insertar el aviso justo encima de la tabla de órdenes
        var tabla = document.getElementById('tabla-ordenes');
        var container = tabla ? tabla.closest('.container') || tabla.parentNode : document.body;
        var aviso = document.createElement('div');
        aviso.className = 'alert alert-success my-2';
        aviso.innerText = 'Tu navegador bloqueó la ventana de WhatsApp. Pulsa el botón para abrir WhatsApp Web.';
        var boton = document.createElement('a');
        boton.href = url;
        boton.target = '_blank';
        boton.rel = 'noopener noreferrer';
        boton.className = 'btn btn-success ms-2';
        boton.innerText = 'Abrir WhatsApp Web';
        aviso.appendChild(boton);
        if (tabla && tabla.parentNode) {
          // Colocar el aviso antes del contenedor de la tabla
          tabla.parentNode.parentNode.insertBefore(aviso, tabla.parentNode);
        } else {
          container.insertBefore(aviso, container.firstChild);
        }
      }
    })();
  </script>
  {% endif %}
{% endblock content %}

{% block datatable_options %}
if ($('#tabla-ordenes').length) {
  $('#tabla-ordenes').DataTable({
    order: [[0, 'desc']],
    language: {
      search: 'Buscar:',
      lengthMenu: 'Mostrar _MENU_ registros',
      info: '_START_ a _END_ de _TOTAL_',
      paginate: { first: 'Primero', last: 'Último', next: 'Siguiente', previous: 'Anterior' }
    },
    columnDefs: [
      { orderable: false, searchable: false, targets: 8 }
    ]
  });
}
{% endblock %}