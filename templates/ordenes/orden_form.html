{% extends 'home/base.html' %}
{% load static %}

{% block title %}
{{ title }}
{% endblock title %}

{% load bootstrap5 %}

{% block content %}
{{ block.super }}
<div class="container py-4">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="h3 mb-0 text-gray-800"><strong>{{ title }}</strong></h1>
    <a href="{% url 'ordenes:orden_list' %}" class="btn btn-outline-secondary">
      <i class="fas fa-arrow-left me-1"></i> Volver al listado
    </a>
  </div>

  <form method="post" enctype="multipart/form-data" class="needs-validation" novalidate>
    {% csrf_token %}

    <!-- Datos del cliente -->
    <div class="card shadow-sm mb-4">
      <div class="card-header py-2 bg-primary text-white">
        <h5 class="card-title mb-0"><i class="fas fa-user me-2"></i>Datos del cliente</h5>
      </div>
      <div class="card-body">
        <div class="row g-3">
          <div class="col-md-4">
            {% bootstrap_field cliente_form.tipo_identificacion layout='inline' %}
          </div>
          <div class="col-md-4">
            {% bootstrap_field cliente_form.cedula layout='inline' %}
            <datalist id="usuario_by_cedula"></datalist>
          </div>
          <div class="col-md-4">
            {% bootstrap_field cliente_form.nombre_apellido layout='inline' %}
            <datalist id="usuario_by_nombre"></datalist>
          </div>
          <div class="col-md-4">
            {% bootstrap_field cliente_form.telefono layout='inline' %}
          </div>
          <div class="col-md-4">
            {% bootstrap_field cliente_form.direccion layout='inline' %}
          </div>
          <div class="col-md-4">
            {% bootstrap_field cliente_form.referencia layout='inline' %}
          </div>
        </div>
      </div>
    </div>

    <!-- Vehículo(s) -->
    <div class="card shadow-sm mb-4">
      <div class="card-header py-2 d-flex justify-content-between align-items-center bg-success text-white">
        <h5 class="card-title mb-0"><i class="fas fa-car me-2"></i>Vehículo(s)</h5>
        <button type="button" class="btn btn-sm btn-light" onclick="duplicarVehiculo()">
          <i class="fas fa-plus me-1"></i> Agregar otro vehículo
        </button>
      </div>
      <div class="card-body" id="contenedor-vehiculos">
        <div class="bloque-vehiculo card border mb-3" id="div_vehiculo" data-numero="1">
          <div class="card-body py-3">
            <div class="row g-3">
              <div class="col-md-3 col-6">
                {% bootstrap_field vehiculo_form.tipo layout='vertical' %}
              </div>
              <div class="col-md-3 col-6">
                {% bootstrap_field vehiculo_form.marca layout='vertical' %}
              </div>
              <div class="col-md-3 col-6">
                {% bootstrap_field vehiculo_form.modelo layout='vertical' %}
              </div>
              <div class="col-md-3 col-6">
                {% bootstrap_field orden_form.kilometraje layout='vertical' %}
              </div>
              <div class="col-md-4 col-6">
                {% bootstrap_field vehiculo_form.placa layout='vertical' %}
              </div>
              <div class="col-md-4 col-6">
                {% bootstrap_field vehiculo_form.password layout='vertical' %}
              </div>
              <div class="col-md-4 col-6">
                {% bootstrap_field orden_form.mecanico layout='vertical' %}
              </div>
              <div class="col-12 col-md-6">
                {% bootstrap_field orden_form.situacion layout='vertical' %}
              </div>
              <div class="col-12 col-md-6">
                {% bootstrap_field orden_form.observacion layout='vertical' %}
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Acciones -->
    <div class="panel-footer text-center">
      <a href="{% url 'ordenes:orden_list' %}" class="btn btn-primary">Cancelar</a>
      <button type="submit" class="btn btn-success" id="btn-guardar-usuario">
        <i class="fas fa-save me-1"></i> Guardar orden
      </button>
    </div>
  </form>
</div>

<script type="text/javascript">
  const url = "{{ request.scheme }}://{{ request.META.HTTP_HOST }}";
</script>
<script src="https://code.jquery.com/jquery-3.6.4.min.js" crossorigin="anonymous"></script>
<script type="text/javascript" src="{% static 'js/orden.js' %}"></script>
<script type="text/javascript" src="{% static 'js/usuario.js' %}"></script>

<script>
(function() {
  var contadorVehiculos = 1;

  function limpiarBloque(bloque) {
    bloque.querySelectorAll('input:not([type="hidden"])').forEach(function(input) {
      input.value = '';
    });
    bloque.querySelectorAll('textarea').forEach(function(ta) {
      ta.value = '';
    });
    bloque.querySelectorAll('select').forEach(function(sel) {
      sel.selectedIndex = 0;
    });
  }

  window.duplicarVehiculo = function() {
    var original = document.getElementById('div_vehiculo');
    var contenedor = document.getElementById('contenedor-vehiculos');
    var clon = original.cloneNode(true);

    contadorVehiculos++;
    clon.id = 'div_vehiculo_' + contadorVehiculos;
    clon.classList.remove('border');
    clon.classList.add('border-info');
    clon.setAttribute('data-numero', contadorVehiculos);

    var titulo = document.createElement('div');
    titulo.className = 'card-header py-2 bg-light d-flex justify-content-between align-items-center';
    titulo.innerHTML = '<span class="fw-bold">Vehículo ' + contadorVehiculos + '</span>' +
      '<button type="button" class="btn btn-sm btn-outline-danger" onclick="quitarVehiculo(this)"><i class="fas fa-times me-1"></i>Quitar</button>';
    clon.insertBefore(titulo, clon.firstChild);

    limpiarBloque(clon);
    contenedor.appendChild(clon);
  };

  window.quitarVehiculo = function(btn) {
    var bloque = btn.closest('.bloque-vehiculo');
    if (document.querySelectorAll('.bloque-vehiculo').length > 1) {
      bloque.remove();
    }
  };
})();
</script>
{% endblock content %}
