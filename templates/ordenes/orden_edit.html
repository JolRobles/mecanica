{% extends 'home/base.html' %}
{% load static %}
{% load l10n %}

{% block title %}
{{ title }}
{% endblock title %}

{% load bootstrap5 %}

{% block content %}
{{ block.super }}
<div class="container py-4">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="h3 mb-0 text-gray-800"><strong>{{ title }}</strong></h1>
    <a href="{% url 'ordenes:orden_list' %}" class="btn btn-outline-secondary">
      <i class="fas fa-arrow-left me-1"></i> Volver al listado
    </a>
  </div>

  <form method="post" enctype="multipart/form-data" class="needs-validation" novalidate>
    {% csrf_token %}

    <!-- Datos del vehículo -->
    <div class="card shadow-sm mb-4">
      <div class="card-header py-2 bg-success text-white">
        <h5 class="card-title mb-0"><i class="fas fa-car me-2"></i>Datos del vehículo</h5>
      </div>
      <div class="card-body">
        <div class="row g-3">
          <div class="col-md-3 col-6">
            {% bootstrap_field vehiculo_form.tipo layout='vertical' %}
          </div>
          <div class="col-md-3 col-6">
            {% bootstrap_field vehiculo_form.marca layout='vertical' %}
          </div>
          <div class="col-md-3 col-6">
            {% bootstrap_field vehiculo_form.modelo layout='vertical' %}
          </div>
          <div class="col-md-3 col-6">
            {% bootstrap_field vehiculo_form.placa layout='vertical' %}
          </div>
          <div class="col-md-3 col-6">
            {% bootstrap_field vehiculo_form.password layout='vertical' %}
          </div>
          <div class="col-md-3 col-6">
            {% bootstrap_field orden_form.mecanico layout='vertical' %}
          </div>
          <div class="col-md-3 col-6">
            {% bootstrap_field orden_form.estado layout='vertical' %}
          </div>
          <div class="col-md-3 col-6">
            {% bootstrap_field orden_form.monto_cobrar layout='vertical' %}
          </div>
          <div class="col-12 col-md-6">
            {% bootstrap_field orden_form.situacion layout='vertical' %}
          </div>
          <div class="col-12 col-md-6">
            {% bootstrap_field orden_form.observacion layout='vertical' %}
          </div>
        </div>
      </div>
    </div>

    <!-- Detalle de productos / servicios -->
    <div class="card shadow-sm mb-4">
      <div class="card-header py-2 d-flex justify-content-between align-items-center bg-primary text-white">
        <h5 class="card-title mb-0"><i class="fas fa-list me-2"></i>Detalle de productos / servicios</h5>
        <button type="button" class="btn btn-sm btn-light" onclick="agregarDetalle()">
          <i class="fas fa-plus me-1"></i> Agregar detalle
        </button>
      </div>
      <div class="card-body">
        <div class="row g-2 mb-2 text-muted small d-none d-md-flex">
          <div class="col-md-2">Acción</div>
          <div class="col-md-3">Descripción</div>
          <div class="col-md-2">Tipo</div>
          <div class="col-md-2">Cantidad</div>
          <div class="col-md-2">Precio</div>
        </div>
        <div id="id_productos">
          {% for item in detalles_orden %}
          <div class="row g-2 align-items-center mb-2 fila-detalle">
            <div class="col-md-2 col-4">
              <button type="button" class="btn btn-sm btn-outline-danger" onclick="eliminarProducto(this)" title="Eliminar">
                <i class="fas fa-trash-alt me-1"></i> Quitar
              </button>
            </div>
            <div class="col-md-2 d-none">
              <input class="form-control form-control-sm" name="pk_detalle" type="text" value="{{ item.detalle.pk }}">
            </div>
            <div class="col-md-3 col-8">
              <input class="form-control form-control-sm" type="text" name="detalle_producto" value="{{ item.detalle.producto|default:'' }}" placeholder="Descripción">
            </div>
            <div class="col-md-2 col-6">
              <select class="form-select form-select-sm" name="tipo_producto">
                <option value="externo" {% if item.detalle.tipo_producto == 'externo' %}selected{% endif %}>Externo</option>
                <option value="inventario" {% if item.detalle.tipo_producto == 'inventario' %}selected{% endif %}>Inventario</option>
              </select>
            </div>
            <div class="col-md-2 col-6">
              <input class="form-control form-control-sm" type="number" step="0.01" min="0" name="cantidad_producto" placeholder="Cantidad" value="{{ item.cantidad_display }}" oninput="calcularCosto()">
            </div>
            <div class="col-md-2 col-6">
              <input class="form-control form-control-sm" type="number" step="0.01" min="0" name="precio_producto" placeholder="0.00" value="{{ item.pvp_display }}" oninput="calcularCosto()">
            </div>
          </div>
          {% endfor %}
        </div>
        <div class="row g-2 align-items-center mt-3 pt-3 border-top fila-total-detalles" id="fila-total-detalles">
          <div class="col-md-2 col-4"></div>
          <div class="col-md-2 d-none"></div>
          <div class="col-md-3 col-8 text-end fw-bold">Total detalles:</div>
          <div class="col-md-2 col-6"></div>
          <div class="col-md-2 col-6"></div>
          <div class="col-md-2 col-6 fw-bold text-success" id="valor-total-detalles">0.00</div>
        </div>
        <p class="text-muted small mb-0 mt-2"><i class="fas fa-info-circle me-1"></i>Cantidad por defecto 1, precio 0.00. El costo total se actualiza al cambiar cantidad o precio.</p>
      </div>
      </div>
    </div>
  </div>   

    <!-- Acciones -->
    <div class="panel-footer text-center">
      <a href="{% url 'ordenes:orden_list' %}" class="btn btn-primary">Cancelar</a>
      <button type="submit" class="btn btn-success" id="btn-guardar-usuario">
        <i class="fas fa-save me-1"></i> Guardar cambios
      </button>
    </div>
    <br>
  </form>
</div>

<script type="text/javascript">
  const url = "{{ request.scheme }}://{{ request.META.HTTP_HOST }}";
</script>
<script src="https://code.jquery.com/jquery-3.6.4.min.js" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script type="text/javascript" src="{% static 'js/orden.js' %}"></script>
<script type="text/javascript" src="{% static 'js/usuario.js' %}"></script>
<script>
  document.addEventListener('DOMContentLoaded', function() {
    if (typeof calcularCosto === 'function') calcularCosto();
  });
</script>
{% endblock content %}
