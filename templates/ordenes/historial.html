{% extends 'home/base.html' %}
{% load static %}

{% block title %}
Historial - Orden {{ orden.pk }}
{% endblock title %}

{% load bootstrap5 %}

{% block content %}
{{ block.super }}
<div class="container py-4">
  <div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mb-4">
    <div>
      <h1 class="h3 mb-1 text-gray-800"><strong>Historial de la orden</strong></h1>
      <p class="text-muted small mb-0">
        Orden #{{ orden.pk }}
        {% if orden.cliente %} · {{ orden.cliente.nombre_apellido }}{% endif %}
        {% if orden.vehiculo %} · {{ orden.vehiculo.placa|default:orden.vehiculo }}{% endif %}
      </p>
    </div>
    <a href="{% url 'ordenes:orden_edit' orden.pk %}" class="btn btn-outline-primary">
      <i class="fas fa-edit me-1"></i> Editar orden
    </a>
    <a href="{% url 'ordenes:orden_list' %}" class="btn btn-outline-secondary">
      <i class="fas fa-arrow-left me-1"></i> Volver al listado
    </a>
  </div>

  <div class="card shadow-sm">
    <div class="card-header py-2 bg-secondary text-white">
      <h5 class="card-title mb-0"><i class="fas fa-history me-2"></i>Cambios de estado</h5>
    </div>
    <div class="card-body p-0">
      {% if historiales %}
      <div class="table-responsive">
        <table id="tabla-historial" class="table table-hover table-striped align-middle mb-0">
          <thead class="table-light">
            <tr>
              <th>Estado</th>
              <th>Fecha y hora</th>
              <th>Técnico / Usuario</th>
            </tr>
          </thead>
          <tbody>
            {% for h in historiales %}
            <tr>
              <td>
                <span class="badge bg-primary">{{ h.estado }}</span>
              </td>
              <td>{{ h.fecha_ingreso|date:"d/m/Y H:i" }}</td>
              <td>{{ h.usuario|default:"—" }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
      <div class="text-center text-muted py-5">
        <i class="fas fa-inbox fa-3x mb-3 opacity-50"></i>
        <p class="mb-0">No hay registros en el historial de esta orden.</p>
      </div>
      {% endif %}
    </div>
  </div>
</div>
{% endblock content %}

{% block datatable_options %}
if ($('#tabla-historial').length && $('#tabla-historial tbody tr').length) {
  $('#tabla-historial').DataTable({
    order: [[1, 'desc']],
    language: {
      search: 'Buscar:',
      lengthMenu: 'Mostrar _MENU_ registros',
      info: '_START_ a _END_ de _TOTAL_',
      paginate: { first: 'Primero', last: 'Último', next: 'Siguiente', previous: 'Anterior' }
    },
    pageLength: 10
  });
}
{% endblock %}
